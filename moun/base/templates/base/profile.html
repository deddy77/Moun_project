{% extends 'main.html' %}
  {% block content %}
    <main class="profile-page layout layout--3">
      <div class="container">
        <!-- Topics Start -->
        {% include 'base/topics_component.html' %}
        <!-- Topics End -->

        <!-- Room List Start -->
        <div class="roomList">
          <div class="profile">
            <div class="profile__avatar">
              <div class="avatar avatar--large" data-avatar-for="{{user.id}}">
                <img src="{{ user.avatar.url }}" />
              </div>
            </div>
            <div class="profile__info">
              <h3>{{user.name}}</h3>
              <p>@{{user.username}} 
                <!-- <span style="color: #b2bdbd;; font-size: 14px;" id="followers">459</span> -->
                <span style="color: #b2bdbd;; font-size: 14px;"  id="followers_count"> </span>
                <span style="color: #b2bdbd;; font-size: 14px;"> Followers</span></p>
              
              {% if request.user == user %}
                  <a href="{% url 'inbox' %}" class="btn btn--sub btn--pill" style="margin-right: 0.5rem;">üì¨ Inbox</a>
                  <a href="{% url 'update-user' %}" class="btn btn--main btn--pill">Edit Profile</a>
              {% else %}
                <a href="#" id="send-message-btn" data-user-id="{{ user.id }}" class="btn btn--sub btn--pill" style="margin-right: 0.5rem;">Send Message</a>
                <form id="follow-form" method="POST" action="{% url 'follow-user' user.id %}" style="display: inline;">
                  {% csrf_token %}
                    {% if is_following %}
                      <button id="follow-button" class="btn btn--main btn--pill">Unfollow</button>
                    {% else %}
                      <button id="follow-button" class="btn btn--main btn--pill">Follow</button>
                    {% endif %}
                </form>
              {% endif %}
          </div>
            <div class="profile__about">
              <h3>ABOUT</h3>
              <p>
                {{user.bio}}
              </p>
            </div>
          </div>

          <div class="roomList__header">
            {% if request.user == user %}
              <h2>Your Rooms</h2>
            {% else %}
              <h2>Rooms Hosted by {{user.name}}</a>
              </h2>
            {% endif %}
            
          </div>
          
          {% include 'base/feed_component.html' %} 
        </div>
        <!-- Room List End -->

        <!-- Activities Start -->
        {% include 'base/activity_component.html' %}
        <!-- Activities End -->
      </div>
    </main>


    <!-- Error Modal -->
    <div id="error-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="color: #e74c3c; margin-bottom: 1rem;">‚ö†Ô∏è Cannot Send Message</h3>
            <p id="error-message" style="color: #333; margin-bottom: 1.5rem;"></p>
            <button onclick="closeErrorModal()" style="background: #3B82F6; color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1rem;">OK</button>
        </div>
    </div>

    <script>
      function showErrorModal(message) {
          document.getElementById('error-message').textContent = message;
          document.getElementById('error-modal').style.display = 'flex';
      }

      function closeErrorModal() {
          document.getElementById('error-modal').style.display = 'none';
      }

      // Handle Send Message button click
      document.getElementById('send-message-btn')?.addEventListener('click', function(e) {
          e.preventDefault();
          const userId = this.dataset.userId;
          
          fetch('/start-conversation/' + userId + '/')
              .then(response => response.json())
              .then(data => {
                  if (data.error) {
                      showErrorModal(data.error);
                  } else if (data.success && data.redirect) {
                      window.location.href = data.redirect;
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  showErrorModal('An error occurred. Please try again.');
              });
      });

      function checkUserStatus() {
          fetch('/check_user_status/')
              .then(response => response.json())
              .then(data => {
                  let online_users = [];
                  for (let userStatus of data) {
                      if (userStatus.is_online) {
                          online_users.push(userStatus.user_id);
                      }
                  }
                  // console.log(online_users);
    
                  // Get all avatar elements with data-avatar-for
                  let avatars = document.querySelectorAll('[data-avatar-for]');
                  avatars.forEach(avatar => {
                      let userId = parseInt(avatar.dataset.avatarFor, 10);
                      if (online_users.includes(userId)) {
                          avatar.classList.add('active');
                      } else {
                          avatar.classList.remove('active');
                      }
                  });

                  // Also get all avatar elements with data-user-id
                  let avatarDivs = document.querySelectorAll('[data-user-id]');
                  avatarDivs.forEach(avatarDiv => {
                      let userId = parseInt(avatarDiv.dataset.userId, 10);
                      if (online_users.includes(userId)) {
                          avatarDiv.classList.add('active');
                      } else {
                          avatarDiv.classList.remove('active');
                      }
                  });
              })
              .catch(error => console.error('Error:', error));
      }
 
      
      async function fetchFollowData() {
        var userId = Number("{{ user.id }}");  // Get user.id from Django and convert it to a number
        try {
            let response = await fetch('/get_follow_data/' + userId + '/');  // Use userId in the URL
            let data = await response.json();
            document.getElementById('followers_count').textContent = ' ' + data.num_followers;  // Use userId to access the data
        } catch (error) {
            console.error('Error:', error);
        }
    }

      // Check user status every 5 seconds
    setInterval(checkUserStatus, 8000);
    fetchFollowData();
    
// Get the form and add an event listener for the submit event
var form = document.getElementById('follow-form');
    form.addEventListener('submit', function(event) {
        // Prevent the form from being submitted
        event.preventDefault();

        // Get the follow button
        var followButton = document.getElementById('follow-button');

        // Send a POST request to the server
        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams(new FormData(form))
        })
        .then(response => response.json())
        .then(data => {
    // testing the data sent
    console.log(data);
    // Get the first key from the data object
    var firstKey = Object.keys(data)[0];
    // Update the follow button text
    if (data[firstKey].is_following) {
        followButton.textContent = 'Unfollow';
    } else {
        followButton.textContent = 'Follow';
    }

    // Fetch follow data
    fetchFollowData();
})
        .catch(error => console.error('Error:', error));
    });

      // Fetch follow data every 80 seconds    
    setInterval(fetchFollowData, 80000);





















</script>







    
    {% endblock content %}  

